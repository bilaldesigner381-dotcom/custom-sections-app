{% assign template = template.name %}

{% assign show_block = false %}
{% case block.settings.visibility %}
  {% when 'all' %}
    {% assign show_block = true %}
  {% when 'home' %}
    {% if template == 'index' %}{% assign show_block = true %}{% endif %}
  {% when 'product' %}
    {% if template contains 'product' %}{% assign show_block = true %}{% endif %}
  {% when 'collection' %}
    {% if template contains 'collection' %}{% assign show_block = true %}{% endif %}
  {% when 'page' %}
    {% if template contains 'page' %}{% assign show_block = true %}{% endif %}
{% endcase %}

{% if show_block %}
<div class="snowfall-wrapper" style="
  margin: {{ block.settings.margin }}px 0;
  padding: {{ block.settings.padding }}px;
  background: {{ block.settings.background_color }};
  {% if block.settings.background_image != blank %}
    background-image: url('{{ block.settings.background_image | image_url: width: 1600 }}');
    background-size: cover;
    background-position: center;
  {% endif %}
">
  <div class="custom-featured-collection"> 
    <h2 class="collection-title" style="font-size: {{ block.settings.title_size }}px; color: {{ block.settings.title_color }}">
      {{ block.settings.title }}
    </h2>

    <div class="product-wrapper {% if block.settings.show_as_slider %}slider-active{% else %}grid-active{% endif %}">
      {% assign collection = collections[block.settings.collection] %}

      {% if collection and collection.products.size > 0 %}
        {% for product in collection.products %}
          <div class="product-card" data-product-id="{{ product.id }}">
            
            <!-- Left Info -->
            <div class="left-info">
              <h3>{{ product.title | escape }}</h3>
              <p>{{ product.price | money }}</p>
              
              {% if product.variants.size > 1 %}
                <div class="color-swatches">
                  {% for variant in product.variants %}
                    {% assign color_name = variant.option1 | default: variant.title | handle %}
                    {% assign variant_image = variant.image | default: product.featured_image %}

                    <div class="swatch" 
                      data-image="{{ variant_image | image_url: width: 200 }}"
                      style="background-color: {{ color_name | color_to_hex | default: '#cccccc' }};"
                      title="{{ variant.option1 | default: variant.title | escape }}">
                    </div>
                  {% endfor %}
                </div>
              {% endif %}

              <a href="{{ product.url }}" class="buy-now-btn">Buy Now</a>
            </div>
            
            <!-- Right Image -->
            <div class="right-image">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | image_url: width: 200 }}" 
                  alt="{{ product.title | escape }}"
                  class="main-image"
                  loading="lazy"
                  width="200"
                  height="200">
              {% else %}
                <p class="no-image">No Product Image</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="no-products">No products found</p>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<style>
/* Product Grid Mode */
.product-wrapper.grid-active {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: center;
}
.product-wrapper {
  padding-top: 10px;
}

/* Slider Mode */
.product-wrapper.slider-active {
  display: flex;
  overflow-x: auto;
  gap: 20px;
  scroll-behavior: smooth;
  padding-bottom: 15px;
}

.product-wrapper.slider-active::-webkit-scrollbar {
  height: 8px;
}
.product-wrapper.slider-active::-webkit-scrollbar-thumb {
  background: #999;
  border-radius: 10px;
}
.product-wrapper.slider-active::-webkit-scrollbar-track {
  background: #eee;
}

/* Product Card */
.product-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 15px;

  flex: 0 0 calc(33.333% - 20px);
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 10px;
  background: #FFF;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.47);
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}

.slider-active .product-card {
  flex: 0 0 300px; /* fixed width in slider */
}

.product-card:hover {
  transform: translateY(-5px);
  background: #000;
  box-shadow: 0 12px 25px rgba(0, 0, 0, 0.58);
}

.product-card:hover h3,
.product-card:hover p,
.product-card:hover .buy-now-btn {
  color: #fff;
}

/* Make all text bold */
.collection-title,
.product-card h3,
.product-card p,
.product-card a,
.no-products,
.no-image {
  font-weight: bold;
}

/* Left Info */
.left-info {
  flex: 1;
}

.left-info h3 {
  font-size: 16px;
  margin: 0 0 5px;
}

.left-info p {
  margin: 0 0 10px;
}

/* Right Image */
.right-image {
  flex-shrink: 0;
}

.right-image img {
  border-radius: 8px;
  max-width: 120px;
  height: auto;
}

/* Swatches */
.color-swatches {
  display: flex;
  gap: 5px;
  margin: 10px 0;
}

.swatch {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  cursor: pointer;
  border: 1px solid #ccc;
}

.buy-now-btn {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 6px;
  background: #eee;
  font-size: 14px;
  text-decoration: none;
  transition: 0.3s;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Variant Image Swatches
  const productCards = document.querySelectorAll('.product-card');

  productCards.forEach(card => {
    const mainImage = card.querySelector('.main-image');
    if (!mainImage) return;

    const defaultImage = mainImage.src;
    const swatches = card.querySelectorAll('.swatch');

    swatches.forEach(swatch => {
      swatch.addEventListener('mouseenter', function () {
        const newImage = this.getAttribute('data-image');
        if (newImage) {
          mainImage.src = newImage;
          mainImage.style.opacity = '0';
          setTimeout(() => {
            mainImage.style.opacity = '1';
          }, 10);
        }
      });

      swatch.addEventListener('mouseleave', function () {
        mainImage.src = defaultImage;
        mainImage.style.opacity = '0';
        setTimeout(() => {
          mainImage.style.opacity = '1';
        }, 10);
      });
    });
  });
});
</script>

{% schema %}
{
  "name": "Featured Collection",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "visibility",
      "label": "Show this block on",
      "options": [
        { "value": "all", "label": "All pages" },
        { "value": "home", "label": "Homepage only" },
        { "value": "product", "label": "Product pages only" },
        { "value": "collection", "label": "Collection pages only" },
        { "value": "page", "label": "Custom pages only" }
      ],
      "default": "page"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Choose Collection"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Our Shoes Collection"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Title Font Size",
      "min": 12,
      "max": 48,
      "step": 1,
      "default": 24
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#0130ff"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    },
    {
      "type": "range",
      "id": "margin",
      "label": "Margin Top & Bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 40
    },
    {
      "type": "range",
      "id": "padding",
      "label": "Section Padding",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "checkbox",
      "id": "show_as_slider",
      "label": "Show products as slider",
      "default": false
    }
  ]
}
{% endschema %}
