{% assign template = template.name %}

{% assign show_block = false %}
{% case block.settings.visibility %}
  {% when 'all' %}
    {% assign show_block = true %}
  {% when 'home' %}
    {% if template == 'index' %}{% assign show_block = true %}{% endif %}
  {% when 'product' %}
    {% if template contains 'product' %}{% assign show_block = true %}{% endif %}
  {% when 'collection' %}
    {% if template contains 'collection' %}{% assign show_block = true %}{% endif %}
  {% when 'page' %}
    {% if template contains 'page' %}{% assign show_block = true %}{% endif %}
{% endcase %}

{% if show_block %}
<div class="testimonials-section"
     style="margin: {{ block.settings.section_margin }}px auto;
            padding: {{ block.settings.section_padding }}px;
            background-color: {{ block.settings.bg_color }};">

  {% if block.settings.heading != blank %}
    <h2 class="testimonials-heading"
        style="font-size: {{ block.settings.heading_size }}px; color: {{ block.settings.heading_color }};">
      {{ block.settings.heading }}
    </h2>
  {% endif %}

  <div class="testimonials-wrapper {% if block.settings.enable_slider %}slider-enabled{% endif %}" id="testimonial-slider-{{ block.id }}">

    {% for i in (1..4) %}
      {% assign t = "testimonial_" | append: i | append: "_text" %}
      {% assign n = "testimonial_" | append: i | append: "_name" %}
      {% assign img = "testimonial_" | append: i | append: "_image" %}

      {% if block.settings[t] != blank %}
        <div class="testimonial-card">
          {% if block.settings[img] != blank %}
            <img src="{{ block.settings[img] | image_url: width: 100 }}"
                 alt="{{ block.settings[n] }}"
                 class="testimonial-image"
                 width="100"
                 height="100" />
          {% endif %}
          <p class="testimonial-text" style="font-size: {{ block.settings.text_size }}px; color: {{ block.settings.text_color }};">
            "{{ block.settings[t] }}"
          </p>
          {% if block.settings[n] != blank %}
            <p class="testimonial-name" style="font-size: {{ block.settings.name_size }}px; color: {{ block.settings.name_color }};">
              â€“ {{ block.settings[n] }}
            </p>
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}

  </div>
</div>
{% endif %}

<style>
.testimonials-section { max-width: 1000px; margin: 0 auto; text-align: center; }
.testimonials-heading { font-weight: bold; margin-bottom: 30px; }

/* Default Grid */
.testimonials-wrapper {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
}

/* Slider Layout */
.testimonials-wrapper.slider-enabled {
  display: flex;
  overflow-x: auto;
  gap: 20px;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 10px;
}
.testimonials-wrapper.slider-enabled .testimonial-card {
  flex: 0 0 80%;
  max-width: 80%;
  scroll-snap-align: center;
}

/* Cards */
.testimonial-card {
  background: #fff;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0px 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.3s ease;
}
.testimonial-card:hover { transform: translateY(-5px); }

.testimonial-image {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  margin-bottom: 15px;
  object-fit: cover;
}

.testimonial-text { font-style: italic; margin-bottom: 10px; }
.testimonial-name { font-weight: 600; }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const slider = document.querySelector("#testimonial-slider-{{ block.id }}");
  if (slider && slider.classList.contains("slider-enabled")) {
    let index = 0;
    const cards = slider.querySelectorAll(".testimonial-card");
    const total = cards.length;

    setInterval(() => {
      index = (index + 1) % total;
      slider.scrollTo({
        left: cards[index].offsetLeft,
        behavior: "smooth"
      });
    }, 5000);
  }
});
</script>

{% schema %}
{
  "name": "Testimonials",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "visibility",
      "label": "Show this block on",
      "options": [
        { "value": "all", "label": "All pages" },
        { "value": "home", "label": "Homepage only" },
        { "value": "product", "label": "Product pages only" },
        { "value": "collection", "label": "Collection pages only" },
        { "value": "page", "label": "Custom pages only" }
      ],
      "default": "home"
    },

    { "type": "text", "id": "heading", "label": "Section Heading", "default": "What Our Customers Say" },

    { "type": "range", "id": "section_margin", "label": "Section Margin (px)", "min": 0, "max": 100, "step": 5, "unit": "px", "default": 40 },
    { "type": "range", "id": "section_padding", "label": "Section Padding (px)", "min": 0, "max": 100, "step": 5, "unit": "px", "default": 30 },
    { "type": "color", "id": "bg_color", "label": "Background Color", "default": "#f9f9f9" },

    { "type": "range", "id": "heading_size", "label": "Heading Font Size", "min": 16, "max": 48, "step": 1, "unit": "px", "default": 26 },
    { "type": "color", "id": "heading_color", "label": "Heading Color", "default": "#000000" },

    { "type": "range", "id": "text_size", "label": "Testimonial Text Size", "min": 12, "max": 28, "step": 1, "unit": "px", "default": 16 },
    { "type": "color", "id": "text_color", "label": "Testimonial Text Color", "default": "#333333" },

    { "type": "range", "id": "name_size", "label": "Customer Name Size", "min": 12, "max": 24, "step": 1, "unit": "px", "default": 14 },
    { "type": "color", "id": "name_color", "label": "Customer Name Color", "default": "#111111" },

    { "type": "checkbox", "id": "enable_slider", "label": "Enable Slider", "default": false },

    { "type": "textarea", "id": "testimonial_1_text", "label": "Testimonial 1 Text" },
    { "type": "text", "id": "testimonial_1_name", "label": "Testimonial 1 Name" },
    { "type": "image_picker", "id": "testimonial_1_image", "label": "Testimonial 1 Image" },

    { "type": "textarea", "id": "testimonial_2_text", "label": "Testimonial 2 Text" },
    { "type": "text", "id": "testimonial_2_name", "label": "Testimonial 2 Name" },
    { "type": "image_picker", "id": "testimonial_2_image", "label": "Testimonial 2 Image" },

    { "type": "textarea", "id": "testimonial_3_text", "label": "Testimonial 3 Text" },
    { "type": "text", "id": "testimonial_3_name", "label": "Testimonial 3 Name" },
    { "type": "image_picker", "id": "testimonial_3_image", "label": "Testimonial 3 Image" },

    { "type": "textarea", "id": "testimonial_4_text", "label": "Testimonial 4 Text" },
    { "type": "text", "id": "testimonial_4_name", "label": "Testimonial 4 Name" },
    { "type": "image_picker", "id": "testimonial_4_image", "label": "Testimonial 4 Image" }
  ]
}
{% endschema %}

